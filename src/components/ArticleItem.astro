---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import { truncateString } from '../utils';
import FormattedDate from '../components/FormattedDate.astro';

interface Props {
  post: CollectionEntry<'blog'>;
}

interface Author {
  name: string,
  image: string,
}

const { post  } = Astro.props;
const authors = await getCollection('author');
const articleAuthor = authors.find((a) => post.data.author != '' && a.data.name == post.data.author)
let author: Author = {
  name: 'Unknown Author',
  image: '',
}

if (articleAuthor != null) {
  author = articleAuthor.data;
}

const data = await fetch(`https://photos.craddock.org/ws.php?format=json&method=pwg.tags.getImages&tag_name=${post.slug}&order=name`).then((response) => response.json());

const heroImage = {
  location: '/placeholder-hero.jpg',
  name: 'no image',
}

if (data && data.result && data.result.images.length > 0) {
  heroImage.location = data.result.images[0].derivatives.xsmall.url;
  heroImage.name = data.result.images[0].name;
}

---
<div class="flex w-1/3 flex-wrap group cursor-pointer">
  <div class="w-full p-1 md:p-2 mb-0">
    <a href={`/blog/${post.slug}`} >
      <img
        alt="gallery"
        class="block h-64 rounded-lg object-cover object-center mb-3"
        style="inset: 0px; color: transparent;"
        sizes="(max-width: 768px) 30vw, 33vw" 
        src={heroImage.location} />
    </a>
    <h2 class="text-lg mb-0 font-semibold leading-snug tracking-tight mt-0 dark:text-white">
      <a href={`/blog/${post.slug}`}>
        <span class="bg-gradient-to-r from-blue-600 to-blue-900 bg-[length:0px_10px] bg-left-bottom duration-500 dark:from-blue-800 dark:to-blue-900">
          {truncateString(post.data.title, 32)}
        </span>
      </a>
    </h2>
    <div>
    <span class="flex items-center space-x-3">
      { post.data.tags && post.data.tags.map((tag: any) => {
        return (
        <a href={`/${tag}/`}>
          <span class="inline-block text-xs font-medium tracking-wider uppercase mt-0 text-blue-600">{tag}</span>
        </a>
        )})
      }
    </span>
    <span class="mt-0 flex items-center space-x-3 text-gray-500 dark:text-gray-400">
      <span class="flex items-center gap-1 h-5">
      { author.image !== '' && (
        <img alt="" loading="lazy" decoding="async" data-nimg="fill" class="h-5 w-5 rounded-full object-cover" src={author.image} />
      )}
      <span class="truncate text-sm">{truncateString(post.data.author, 15)}</span>
        <span class="text-xs text-gray-300 dark:text-gray-600">â€¢</span>
      </span>
      <FormattedDate date={post.data.pubDate} />
    </span>
    </div>
  </div>
</div>

